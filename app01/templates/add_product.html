<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Add Product</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    {% extends 'base.html' %}
    {% block content %}
    <div class="container mt-5">
        <h2 class="mb-4">Add Product</h2>
        <form method="post" enctype="multipart/form-data" class="needs-validation" novalidate>
            {% csrf_token %}
            <div class="mb-3">
                {{ product_form.as_p }}
            </div>

            <h3 class="my-4">Materials</h3>
            {{ material_formset.management_form }}
            <div id="formset">
                {% for form in material_formset %}
                    <div class="material-form mb-3">
                        {{ form.as_p }}
                    </div>
                {% endfor %}
            </div>
            <button type="button" id="add-material" class="btn btn-secondary mb-3">Add Material</button>

            <button type="submit" class="btn btn-primary">Save Product</button>
        </form>
    </div>

    <script>
        (function () {
            'use strict'
            var forms = document.querySelectorAll('.needs-validation')
            Array.prototype.slice.call(forms)
                .forEach(function (form) {
                    form.addEventListener('submit', function (event) {
                        if (!form.checkValidity()) {
                            event.preventDefault()
                            event.stopPropagation()
                        }
                        form.classList.add('was-validated')
                    }, false)
                })
        })()

        $('#add-material').click(function() {
            const formCount = $('#id_productmaterial_set-TOTAL_FORMS').val();
            const newFormIndex = parseInt(formCount);

            const form = $('#formset .material-form:first').clone(true);
            form.find(':input').each(function() {
                const oldName = $(this).attr('name');
                const newName = oldName.replace(`-${newFormIndex - 1}-`, `-${newFormIndex}-`);
                $(this).attr('name', newName);
                $(this).val('');
            });

            form.insertBefore($('#add-material'));
            $('#id_productmaterial_set-TOTAL_FORMS').val(newFormIndex + 1);
        });
    </script>
    {% endblock %}
</body>
</html>
